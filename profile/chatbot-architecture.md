# 챗봇(재무비서) 아키텍처 초안

> **상태**: 초안 — 초기 설계 참고용
> **작성일**: 2026-02-04

---

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                    Flutter App                           │
│  ┌──────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │  가계부   │  │  정책 피드    │  │  챗봇 (재무비서)  │  │
│  └─────┬────┘  └──────┬───────┘  └────────┬──────────┘  │
└────────┼──────────────┼───────────────────┼──────────────┘
         │              │                   │
         ▼              ▼                   ▼
┌─────────────────────────────────────────────────────────┐
│                   백엔드 API 서버                        │
│                                                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────────────┐ │
│  │ 가계부 API  │  │ 정책 API   │  │    대화 API        │ │
│  │ CRUD       │  │ 매칭/조회   │  │                    │ │
│  └─────┬──────┘  └─────┬──────┘  │  프로필 해석        │ │
│        │               │         │  → 정책 매칭        │ │
│        │               │         │  → 프롬프트 조립     │ │
│        │               │         │  → LLM 호출         │ │
│        │               │         │  → 출처 첨부         │ │
│        │               │         └────────┬───────────┘ │
│        │               │                  │              │
└────────┼───────────────┼──────────────────┼──────────────┘
         │               │                  │
         ▼               ▼                  ▼
┌──────────────┐  ┌────────────┐     ┌────────────┐
│  서비스 DB    │  │  정책 DB   │     │  LLM API   │
│  - users     │  │  policies  │     │  (Claude/   │
│  - accounts  │  │  changes   │     │   GPT 등)   │
│  - txns      │  │  snapshots │     └────────────┘
│  - profiles  │  └────────────┘
│  - chats     │        ↑
└──────────────┘   collector가
                   자동 동기화
```

---

## 2. 사용자 프로필 설계

가계부 데이터에서 **자동 추론**하는 트랙과 사용자가 **직접 입력**하는 트랙, 두 가지로 구성한다.

### 2.1 자동 추론 (가계부 트랜잭션 기반)

| 거래 패턴 | 추론 가능 정보 |
|----------|---------------|
| 급여 입금 패턴 | 월 소득 범위 |
| 월세/전세 이체 | 주거 형태, 보증금 추정 |
| 결제 위치 클러스터 | 거주 지역 |
| 유아용품/학원비 | 자녀 여부, 생애단계 |
| 결혼식장/웨딩 결제 | 결혼 준비 중 |

### 2.2 직접 입력 (온보딩 또는 설정)

- 생년월일 → 나이
- 결혼 여부 / 혼인 신고일
- 자녀 수 / 자녀 나이
- 직업 유형 (직장인/자영업/무직/학생)
- 주거 형태 (자가/전세/월세)
- 관심 분야 (주거/금융/취업/육아/교육)

### 2.3 프로필 스키마

```
user_profiles
  ├── user_id
  ├── birth_date
  ├── region               (시/도)
  ├── marital_status       (single/married/newlywed)
  ├── marriage_date
  ├── children_count
  ├── children_ages        (JSONB [2, 5])
  ├── employment_type      (employed/self/unemployed/student)
  ├── estimated_income     (자동 추론값)
  ├── declared_income      (직접 입력값)
  ├── housing_type         (own/jeonse/monthly)
  ├── interests            (JSONB ["housing", "finance", "childcare"])
  └── updated_at
```

---

## 3. 대화 처리 흐름

하나의 사용자 질문이 답변으로 변환되기까지의 파이프라인이다.

```
사용자 질문
    │
    ▼
┌───────────────────┐
│ [1] 의도 분류      │  키워드/패턴 기반 1차 분류
│                    │  분류 불가시 LLM 위임
└────────┬──────────┘
         │
   ┌─────┴─────┐
   ▼           ▼
정책/금융    가계부 질문
   │           │
   ▼           ▼
┌──────┐   ┌──────┐
│[2]   │   │거래  │
│프로필 │   │내역  │
│로드  │   │조회  │
└──┬───┘   └──┬───┘
   │          │
   ▼          │
┌──────┐      │
│[3]   │      │
│정책  │      │
│매칭  │      │
│(SQL) │      │
└──┬───┘      │
   │          │
   └────┬─────┘
        ▼
┌───────────────────┐
│ [4] 프롬프트 조립  │  시스템 프롬프트
│                    │  + 프로필 컨텍스트
│                    │  + 매칭 결과 / 분석 결과
│                    │  + 대화 히스토리
└────────┬──────────┘
         ▼
┌───────────────────┐
│ [5] LLM 호출      │  Claude / GPT 등
└────────┬──────────┘
         ▼
┌───────────────────┐
│ [6] 후처리        │  출처 태그 삽입
│                    │  정책 카드 링크
│                    │  히스토리 저장
└───────────────────┘
```

### 3.1 의도 분류

비용 효율을 위해 **규칙 기반 1차 분류 + LLM 폴백** 구조를 채택한다.

```
키워드 매핑:
  "대출", "금리", "전세", "이자"       → 금융상품 매칭
  "지원금", "신청", "자격", "정책"     → 정책 매칭
  "지출", "절약", "이번 달", "얼마"    → 가계부 분석
  분류 불가                           → LLM에게 의도 분류 위임
```

LLM을 의도 분류에 매번 사용하면 호출이 2회(분류 + 답변)로 늘어나 비용이 2배가 된다.
규칙 기반으로 대부분을 커버하고, 애매한 경우에만 LLM을 사용하는 방식이 초기에 현실적이다.

### 3.2 정책 매칭

벡터 유사도 검색(RAG)이 아닌 **SQL 조건 매칭**을 사용한다.

```sql
SELECT * FROM policies
WHERE status = 'active'
  AND (min_age IS NULL OR min_age <= :user_age)
  AND (max_age IS NULL OR max_age >= :user_age)
  AND (region IS NULL OR region IN (:user_region, '전국'))
  AND (application_end IS NULL OR application_end >= NOW())
  AND category IN (:relevant_categories)
ORDER BY application_end ASC NULLS LAST
LIMIT 5;
```

정책 데이터는 나이, 소득, 지역 등 **구조화된 조건 필드**를 갖고 있어
임베딩 유사도보다 SQL 필터가 정확도와 비용 모두 유리하다.

| | 벡터 RAG | SQL 매칭 + LLM |
|---|---|---|
| 검색 | 임베딩 유사도 | SQL 조건 필터 |
| 최신성 | 임베딩 재생성 필요 | collector가 DB 업데이트하면 즉시 반영 |
| 인프라 | 벡터 DB 추가 필요 | 기존 PostgreSQL 활용 |
| 추가 비용 | 임베딩 + 벡터 DB ~$70/월 | 없음 |

비정형 질문이 많아지는 시점에 벡터 검색을 부분적으로 도입하는 것은 추후 검토.

---

## 4. 프롬프트 구조

```
[시스템 프롬프트]
당신은 LaPlaPl 재무 비서입니다.
사용자의 재무 상황을 이해하고, 정책/금융 정보를 정확하게 안내합니다.

규칙:
- 제공된 정책 데이터에만 근거하여 답변하세요
- 데이터에 없는 내용은 "확인이 필요합니다"라고 답하세요
- 반드시 출처(정책명, 소스, 수집일시)를 명시하세요
- 금액/금리/기한은 정확한 숫자로 답하세요
- 사용자의 프로필 기준으로 자격 여부를 판단해주세요

[사용자 프로필]
나이: 29세, 기혼(신혼 8개월), 서울 거주
소득: 월 300만원 (부부합산 550만원 추정)
주거: 전세, 자녀: 없음
관심: 주거, 금융

[매칭된 정책 데이터 - 3건]
---정책 1---
정책명: 신혼부부 버팀목 전세자금대출
출처: HF대출 API (2025-02-04 수집)
금리: 연 1.5%~2.1%
한도: 수도권 3억원
대상: 혼인 7년 이내, 부부합산 6천만원 이하
필요서류: 혼인관계증명서, 소득증빙...
...rawData에서 추출한 상세 정보...
---정책 2---
...
---정책 3---
...

[이전 대화]
사용자: 전세대출 알아보고 있어
비서: 현재 프로필 기준으로 3가지 상품을 찾았습니다...
사용자: 금리 제일 싼 건?   ← 현재 질문
```

이 구조의 핵심은 **LLM이 직접 정책을 검색하지 않는다**는 점이다.
매칭 엔진(SQL)이 정확하게 필터링한 결과만 LLM에게 전달하고,
LLM은 그 데이터를 바탕으로 자연어 답변을 생성하는 역할만 한다.

---

## 5. 대화 히스토리 관리

### 5.1 스키마

```
chat_sessions
  ├── id
  ├── user_id
  ├── title              (자동 생성: "전세대출 상담")
  ├── created_at
  └── last_active_at

chat_messages
  ├── id
  ├── session_id
  ├── role               (user / assistant)
  ├── content            (메시지 텍스트)
  ├── metadata           (JSONB)
  │   ├── intent            (분류된 의도)
  │   ├── matched_policies  (매칭된 정책 ID 목록)
  │   ├── sources           (출처 정보)
  │   └── tokens_used       (비용 추적)
  └── created_at
```

### 5.2 히스토리 전달 전략

LLM에 전달하는 대화 히스토리 양에 따라 비용이 비례 증가하므로,
**최근 6~8턴 원문 + 이전 대화 요약 1개**를 전달하는 방식을 채택한다.

```
[요약] 사용자는 29세 신혼부부로 전세대출을 알아보고 있으며,
       버팀목 전세대출에 관심을 보였음.
[최근 대화]
사용자: 금리 제일 싼 건?
비서: 현재 기준으로는...
사용자: 그거 신청하려면?  ← 현재 질문
```

---

## 6. 구현 순서

### 1단계: 정책 매칭 API

- 프로필 → SQL 쿼리 → 매칭 정책 반환
- collector DB를 읽기만 하면 됨
- 챗봇 없이 "내가 받을 수 있는 정책 목록"만으로도 서비스 가치가 있음

### 2단계: 단발 질의 챗봇

- 질문 → 의도분류 → 매칭 → LLM 답변 (히스토리 없이)
- 프롬프트 품질 튜닝에 집중
- 출처 표기 정확성 검증

### 3단계: 맥락 대화

- 세션 관리 + 히스토리
- 의도 분류 고도화
- 대화 요약 파이프라인

### 4단계: 가계부 연동

- 프로필 자동 추론 엔진
- 능동적 추천 ("새로운 정책이 나왔어요")
- 변경 알림 (collector의 change_logs 기반)

---

## 7. 미결정 사항

| 항목 | 선택지 | 비고 |
|------|--------|------|
| LLM 모델 | Claude / GPT-4o / GPT-4o-mini | 품질 vs 비용 트레이드오프 |
| 백엔드 프레임워크 | 서비스 API 설계 시 결정 | |
| 프로필 자동 추론 범위 | MVP에서는 직접 입력만 | 가계부 연동은 3~4단계 |
| 알림 채널 | 앱 푸시 / 인앱 메시지 | |
| 대화 저장 기간 | 무제한 / 최근 N개월 | 비용 vs UX |
